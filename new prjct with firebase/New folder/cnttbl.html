<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title> contact Table Details</title>
  </head>
  <!---boostrab link--->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  />
  <body>
      <!----table for donation Details--->
      <div class="table">
         <div class="container mt-5">
  <h2 class="mb-4">Contact Details</h2>
  <div class="table-responsive">
    <table class="table table-bordered table-striped table-hover w-100  text-center"><!---ithu colur shade kku then center-------->
      <thead class="table-dark"><!---top la heed ku--->
              <th>First Name</th>
              <th>Last Name</th>
              <th>Email</th>
              <th>Mobile</th>
              <th>Message</th>
            <th colspan="2">Actions</th>
            </tr>
          </thead>
          <tbody id="contacttable"></tbody><!-----tbl id---->
        </table>
      </div>
    </div>
          
          <!----scribpt in dlete btn and edit---------------------------------------------------------------------->

          <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
      import {
        getDatabase,
        ref,
        push,
        set,
        get,
        child,
        remove,update  //ithula update and remove must
      } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
      //important line for all code
      const firebaseConfig = {
        databaseURL: "https://finalyrsprjct-default-rtdb.firebaseio.com/",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

//async = Function ah asynchronous (Promise return panna ready) nu mark panna.
//await = Promise resolve aagum varai wait panni value eduthuka.
//asynchronous code ah step by step, easy ah handle panna.

//Snapshot = Database la irukkura data oda current photo / copy (read-only).
//üëâ .val() = photo la irukkura actual content

       async function fetchcontacts() {
        const dbRef = ref(db);   // root element 
        try {
          const snapshot = await get(child(dbRef, "cnttbl"));
          if (snapshot.exists()) {
            const data = snapshot.val();
            const table = document.getElementById("contacttable");// tbl id
            table.innerHTML = ""; // clear table before adding  ithu not allowed table.innerHTML = "" ‚Üí old rows (display aana data) clear pannidum.
                                   //Form (input fields like name, phone etc.) untouched ah irukkum.
                // data  fulla js la  object than detect panuom
              // id na fb la ulia key sdonation na element 

              //donation = oru donation ku related full data (name, phone, city, amt, etc.).
             //Adhula donation.nme, donation.amt nu use pannitu table la display panrom.

            Object.entries(data).forEach(([id, cnts]) =>  {
              const row = document.createElement("tr");
              // ithula stoe aguiruka name la fb db la uiltahu
              row.innerHTML = `
                <td>${cnts.frstnme}</td>
                <td>${cnts.lstnme}</td>
                <td>${cnts.eml}</td>
                <td>${cnts.mbl}</td>
                <td>${cnts.msg}</td>
                <td>
    <button  type="submit"class="btn btn-sm btn-warning editBtn" data-id="${id}">Edit</button>
  </td>
  <td>
    <button  type="submit"class="btn btn-sm btn-danger deleteBtn" data-id="${id}">Delete</button>
  </td>
`; 
              table.appendChild(row);
            });
            } else {
            alert("No contacts found.");//data ilana  return panum
          }
        } catch (error) {
          console.error("Error fetching contacts:", error);
        }
      }
      fetchcontacts();
      //####### id ethukuna itha base vachi athan delete and edit panuvom so

      
document.addEventListener("click", async (e) => {
  if (e.target.classList.contains("deleteBtn")) {
    const id = e.target.dataset.id; // uniqi id kekaidum delete pana datsa oda  dataset modern and clean and easy
    

    Swal.fire({
      title: "Are you sure?",
      text: "Surely delete this item?",
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "Yes, delete it!",
      cancelButtonText: "No, keep it",
    }).then(async (result) => {
      //Firebase DB ku path set pannuthu.
    //ref(db, "dnttbl/123") ‚Üí DB la dnttbl table (folder) ku pogum, andha id row ku point pannum. antha const ref line
      if (result.isConfirmed) {
        try {
          const cntsRef = ref(db, `cnttbl/${id}`);
          await remove(cntsRef);
          Swal.fire("Deleted!", "The item has been deleted.", "success");
          fetchcontacts(); // refresh table after delete
        } catch (error) {
          console.error("Error deleting donation:", error);
          Swal.fire("Error!", "Could not delete item.", "error");
        }
      }
    });
  }
});

    // EDIT / UPDATE

    // Edit button click event
  document.addEventListener("click",async function (e) {
    if (e.target.classList.contains("editBtn")) {
     const id = e.target.dataset.id;
      // old mathod get attribute 

    try {
      // Now await will work
      const cntsSnapshot = await get(child(ref(db), `cnttbl/${id}`));
      if (cntsSnapshot.exists()) {
        const oldData = cntsSnapshot.val(); //Book la old content paakardhu

        //db ‚Üí ungaloda Realtime Database connection.
        //ref(db) ‚Üí whole DB ku pointer.

          //Database la data fetch panna konjam time agum (server request).
          //await kudutha ‚Üí wait pannum, result vandha udane donationSnapshot la store pannidum. await 

    // SweetAlert popup form
    Swal.fire({
      title: "Edit contacts",
      width:"1200px",
      html: `
        <input id="swal-frstnme" class="swal2-input" placeholder="frstnme" value="${oldData.frstnme}">
        <input id="swal-lstnme" class="swal2-input" placeholder="lstnme" value="${oldData.lstnme}">
        <input id="swal-eml" class="swal2-input" placeholder="eml" value="${oldData.eml}">
        <input id="swal-mbl" class="swal2-input" placeholder="mbl" value="${oldData.mbl}">
        <input id="swal-msg" class="swal2-input" placeholder="msg" value="${oldData.msg}">
      `,
      focusConfirm: false,
      showCancelButton: true,
      confirmButtonText: "Save Changes",
      preConfirm: () => {
        return {
          frstnme: document.getElementById("swal-frstnme").value,
          lstnme: document.getElementById("swal-lstnme").value,
          eml: document.getElementById("swal-eml").value,
          mbl: document.getElementById("swal-mbl").value,
          msg: document.getElementById("swal-msg").value,
        };
      }
      //User edit panna values collect pannidum ‚Üí JSON object ready agum.  preconfirm
    }).then(async (result) => {
          if (result.isConfirmed) {
            try {
              const cntsRef = ref(db, `cnttbl/${recordId}`);  // save the new content
              await update(cntsRef, result.value);
              Swal.fire("‚úÖ Updated!", "Donation updated successfully.", "success");
              fetchcontacts(); // refresh table
            } catch (error) {
              console.error("Error updating contacts:", error);
              Swal.fire("‚ùå Error!", "Could not update contts.", "error");
            }
          }
        });
      }
    } catch (error) {
      console.error("Error fetching contacts for edit:", error);
    }
  }
});


</script>

<style>
  .swal2-popup {
  border: 3px solid #4CAF50;   /* Green border */
  border-radius: 12px;         /* Rounded corners */
  background-color: #fefefe;   /* Light blue background */
}
  </style>

   
  </body>
</html>
